<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Keys Profile Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: #e0e0e0;
        }

        /* ── Form View ── */
        .form-view {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-container { width: 100%; max-width: 520px; padding: 20px; }

        .card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.4);
        }

        .logo { text-align: center; margin-bottom: 8px; }
        .logo svg { width: 56px; height: 56px; }

        h1 {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #f5d5a0, #e8a87c, #d4a0d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.45);
            margin-bottom: 36px;
        }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            color: #f0f0f0;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }

        input:focus {
            border-color: rgba(232, 168, 124, 0.5);
            box-shadow: 0 0 0 3px rgba(232, 168, 124, 0.1);
        }

        input::placeholder { color: rgba(255, 255, 255, 0.25); }
        input[type="date"], input[type="time"] { color-scheme: dark; }

        .row { display: flex; gap: 14px; }
        .row .form-group { flex: 1; }

        .hint { font-size: 0.75rem; color: rgba(255, 255, 255, 0.3); margin-top: 4px; }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            margin-top: 8px;
        }

        button:active { transform: scale(0.98); }

        .btn-primary {
            background: linear-gradient(135deg, #e8a87c, #d4a0d4);
            color: #1a1a2e;
            box-shadow: 0 4px 24px rgba(232, 168, 124, 0.3);
        }

        .btn-primary:hover { box-shadow: 0 6px 32px rgba(232, 168, 124, 0.45); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .spinner {
            display: none;
            width: 20px; height: 20px;
            border: 2.5px solid rgba(26, 26, 46, 0.3);
            border-top-color: #1a1a2e;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-msg {
            background: rgba(255, 80, 80, 0.15);
            border: 1px solid rgba(255, 80, 80, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 0.85rem;
            color: #ff8a8a;
            margin-top: 16px;
            display: none;
        }

        /* ── Location Autocomplete ── */
        .autocomplete-wrap { position: relative; }

        .autocomplete-list {
            position: absolute;
            top: 100%; left: 0; right: 0; z-index: 50;
            margin-top: 4px;
            background: rgba(30, 28, 60, 0.97);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .autocomplete-list.show { display: block; }

        .autocomplete-item {
            padding: 12px 16px;
            font-size: 0.88rem;
            color: #e0e0e0;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.12s;
        }

        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover, .autocomplete-item.active { background: rgba(232, 168, 124, 0.15); }
        .autocomplete-item .loc-main { font-weight: 500; }
        .autocomplete-item .loc-detail { font-size: 0.75rem; color: rgba(255, 255, 255, 0.35); margin-top: 2px; }

        .autocomplete-loading {
            padding: 12px 16px;
            font-size: 0.82rem;
            color: rgba(255, 255, 255, 0.35);
            text-align: center;
        }

        /* ── Results View ── */
        .results-view { display: none; }

        .page-header { text-align: center; padding: 48px 20px 32px; }

        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .birth-info { font-size: 0.9rem; color: rgba(255, 255, 255, 0.45); }

        .actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            text-decoration: none;
            border: none;
            transition: transform 0.15s, box-shadow 0.15s;
            width: auto;
            margin-top: 0;
        }

        .btn:active { transform: scale(0.97); }

        .btn-pdf {
            background: linear-gradient(135deg, #e8a87c, #d4a0d4);
            color: #1a1a2e;
            box-shadow: 0 4px 20px rgba(232, 168, 124, 0.3);
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .results-container { max-width: 960px; margin: 0 auto; padding: 0 20px 60px; }

        /* Overview table */
        .overview {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            overflow: hidden;
            margin-bottom: 40px;
        }

        .overview table { width: 100%; border-collapse: collapse; }

        .overview th {
            background: rgba(255, 255, 255, 0.06);
            padding: 14px 16px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: rgba(255, 255, 255, 0.45);
            font-weight: 600;
        }

        .overview td {
            padding: 12px 16px;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .overview tr:hover td { background: rgba(255, 255, 255, 0.03); }

        .gate-num {
            font-weight: 700; font-size: 1.1rem;
            background: linear-gradient(135deg, #f5d5a0, #e8a87c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .line-num { color: rgba(255, 255, 255, 0.4); }
        .kw-shadow { color: #e07a5f; }
        .kw-gift { color: #81b29a; }
        .kw-siddhi { color: #b8a9e8; }

        /* Sequence sections */
        .sequence { margin-bottom: 36px; }

        .sequence-title {
            font-size: 1.2rem; font-weight: 600;
            margin-bottom: 16px; padding-left: 16px;
            border-left: 3px solid;
        }

        .seq-activation .sequence-title { border-color: #e07a5f; color: #e07a5f; }
        .seq-venus .sequence-title { border-color: #d4a0d4; color: #d4a0d4; }
        .seq-pearl .sequence-title { border-color: #f5d5a0; color: #f5d5a0; }

        .sphere-cards { display: grid; gap: 16px; }

        .sphere-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px 28px;
            transition: border-color 0.2s;
        }

        .sphere-card:hover { border-color: rgba(255, 255, 255, 0.18); }

        .sphere-top {
            display: flex; align-items: baseline;
            justify-content: space-between; margin-bottom: 16px;
        }

        .sphere-name { font-size: 1rem; font-weight: 600; color: rgba(255, 255, 255, 0.85); }

        .sphere-gate {
            font-size: 1.3rem; font-weight: 700;
            background: linear-gradient(135deg, #f5d5a0, #e8a87c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sphere-line { font-size: 0.85rem; color: rgba(255, 255, 255, 0.35); font-weight: 400; }

        .freq-bands { display: grid; gap: 12px; }

        .freq-band { display: grid; grid-template-columns: 80px 1fr; gap: 8px; align-items: start; }

        .freq-label {
            font-size: 0.72rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.06em; padding-top: 2px;
        }

        .freq-label.shadow { color: #e07a5f; }
        .freq-label.gift { color: #81b29a; }
        .freq-label.siddhi { color: #b8a9e8; }

        .freq-content { font-size: 0.88rem; line-height: 1.5; }
        .freq-keyword { font-weight: 600; color: rgba(255, 255, 255, 0.85); }
        .freq-desc { color: rgba(255, 255, 255, 0.45); margin-top: 2px; font-size: 0.82rem; }

        @media (max-width: 600px) {
            .card { padding: 36px 24px; }
            .page-header h1 { font-size: 1.5rem; }
            .sphere-card { padding: 18px 20px; }
            .freq-band { grid-template-columns: 1fr; gap: 2px; }
            .overview { overflow-x: auto; }
        }
    </style>
</head>
<body>

<!-- ════════════ FORM VIEW ════════════ -->
<div class="form-view" id="formView">
    <div class="form-container">
        <div class="card">
            <div class="logo">
                <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="32" cy="32" r="28" stroke="url(#g1)" stroke-width="2" opacity="0.6"/>
                    <circle cx="32" cy="32" r="18" stroke="url(#g1)" stroke-width="1.5" opacity="0.4"/>
                    <circle cx="32" cy="32" r="5" fill="url(#g1)" opacity="0.8"/>
                    <line x1="32" y1="4" x2="32" y2="14" stroke="url(#g1)" stroke-width="1.5" opacity="0.5"/>
                    <line x1="32" y1="50" x2="32" y2="60" stroke="url(#g1)" stroke-width="1.5" opacity="0.5"/>
                    <line x1="4" y1="32" x2="14" y2="32" stroke="url(#g1)" stroke-width="1.5" opacity="0.5"/>
                    <line x1="50" y1="32" x2="60" y2="32" stroke="url(#g1)" stroke-width="1.5" opacity="0.5"/>
                    <defs>
                        <linearGradient id="g1" x1="0" y1="0" x2="64" y2="64">
                            <stop stop-color="#f5d5a0"/>
                            <stop offset="1" stop-color="#d4a0d4"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <h1>Gene Keys</h1>
            <p class="subtitle">Hologenetic Profile Calculator</p>

            <form id="profileForm">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" placeholder="e.g. Kailash" required>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="date">Birth Date</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="time">Birth Time</label>
                        <input type="time" id="time" name="time" value="12:00">
                        <div class="hint">Default 12:00 if unknown</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="location">Birth Location</label>
                    <div class="autocomplete-wrap">
                        <input type="text" id="location" name="location" placeholder="Start typing a city..." required autocomplete="off">
                        <div class="autocomplete-list" id="locDropdown"></div>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    <span id="btnText">Generate Profile</span>
                    <div class="spinner" id="spinner"></div>
                </button>

                <div class="error-msg" id="errorMsg"></div>
            </form>
        </div>
    </div>
</div>

<!-- ════════════ RESULTS VIEW ════════════ -->
<div class="results-view" id="resultsView">
    <div class="page-header">
        <h1 id="resultName"></h1>
        <div class="birth-info" id="resultInfo"></div>
        <div class="actions">
            <button class="btn btn-back" id="backBtn">&#8592; New Profile</button>
            <button class="btn btn-pdf" id="pdfBtn">&#8595; Download PDF</button>
        </div>
    </div>
    <div class="results-container">
        <div class="overview">
            <table>
                <thead>
                    <tr>
                        <th>Sphere</th>
                        <th>Key</th>
                        <th>Line</th>
                        <th>Shadow</th>
                        <th>Gift</th>
                        <th>Siddhi</th>
                    </tr>
                </thead>
                <tbody id="overviewBody"></tbody>
            </table>
        </div>
        <div id="detailSections"></div>
    </div>
</div>

<script>
(function () {
    const formView = document.getElementById('formView');
    const resultsView = document.getElementById('resultsView');
    const form = document.getElementById('profileForm');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const submitBtn = document.getElementById('submitBtn');
    const errorMsg = document.getElementById('errorMsg');
    let lastPayload = null;

    const SEQ_CLASSES = {
        'Activation Sequence': 'seq-activation',
        'Venus Sequence': 'seq-venus',
        'Pearl Sequence': 'seq-pearl'
    };

    // ── Form submit ──
    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        errorMsg.style.display = 'none';
        btnText.style.display = 'none';
        spinner.style.display = 'block';
        submitBtn.disabled = true;

        const payload = {
            name: document.getElementById('name').value.trim(),
            date: document.getElementById('date').value.trim(),
            time: document.getElementById('time').value.trim() || '12:00',
            location: document.getElementById('location').value.trim()
        };

        try {
            const res = await fetch('/api/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || 'Calculation failed');
            }

            lastPayload = payload;
            renderResults(data);
            formView.style.display = 'none';
            resultsView.style.display = 'block';
            window.scrollTo(0, 0);
        } catch (err) {
            errorMsg.textContent = err.message;
            errorMsg.style.display = 'block';
        } finally {
            btnText.style.display = '';
            spinner.style.display = 'none';
            submitBtn.disabled = false;
        }
    });

    // ── Back button ──
    document.getElementById('backBtn').addEventListener('click', function () {
        resultsView.style.display = 'none';
        formView.style.display = 'flex';
    });

    // ── PDF download ──
    document.getElementById('pdfBtn').addEventListener('click', async function () {
        if (!lastPayload) return;
        this.disabled = true;
        this.textContent = 'Generating...';

        try {
            const res = await fetch('/download-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(lastPayload)
            });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = lastPayload.name.replace(/ /g, '_') + '_genekeys.pdf';
            a.click();
            URL.revokeObjectURL(url);
        } catch (err) {
            alert('PDF download failed: ' + err.message);
        } finally {
            this.disabled = false;
            this.innerHTML = '&#8595; Download PDF';
        }
    });

    // ── Render results ──
    function renderResults(data) {
        document.getElementById('resultName').textContent = data.name;
        document.getElementById('resultInfo').textContent =
            `${data.date} at ${data.time} \u2014 ${data.location}`;

        // Overview table
        const tbody = document.getElementById('overviewBody');
        tbody.innerHTML = '';
        for (const [seqName, spheres] of Object.entries(data.results)) {
            for (const s of spheres) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.sphere}</td>
                    <td><span class="gate-num">${s.gate}</span></td>
                    <td><span class="line-num">${s.line}</span></td>
                    <td><span class="kw-shadow">${s.shadow.keyword}</span></td>
                    <td><span class="kw-gift">${s.gift.keyword}</span></td>
                    <td><span class="kw-siddhi">${s.siddhi.keyword}</span></td>`;
                tbody.appendChild(tr);
            }
        }

        // Detail sections
        const detail = document.getElementById('detailSections');
        detail.innerHTML = '';
        for (const [seqName, spheres] of Object.entries(data.results)) {
            const seqClass = SEQ_CLASSES[seqName] || '';
            let html = `<div class="sequence ${seqClass}">
                <div class="sequence-title">${seqName}</div>
                <div class="sphere-cards">`;

            for (const s of spheres) {
                html += `
                <div class="sphere-card">
                    <div class="sphere-top">
                        <span class="sphere-name">${s.sphere}</span>
                        <span>
                            <span class="sphere-gate">${s.gate}</span>
                            <span class="sphere-line">.${s.line}</span>
                        </span>
                    </div>
                    <div class="freq-bands">
                        <div class="freq-band">
                            <div class="freq-label shadow">Shadow</div>
                            <div class="freq-content">
                                <div class="freq-keyword">${s.shadow.keyword}</div>
                                <div class="freq-desc">${s.shadow.description}</div>
                            </div>
                        </div>
                        <div class="freq-band">
                            <div class="freq-label gift">Gift</div>
                            <div class="freq-content">
                                <div class="freq-keyword">${s.gift.keyword}</div>
                                <div class="freq-desc">${s.gift.description}</div>
                            </div>
                        </div>
                        <div class="freq-band">
                            <div class="freq-label siddhi">Siddhi</div>
                            <div class="freq-content">
                                <div class="freq-keyword">${s.siddhi.keyword}</div>
                                <div class="freq-desc">${s.siddhi.description}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            html += '</div></div>';
            detail.innerHTML += html;
        }
    }

    // ── Location Autocomplete ──
    const locInput = document.getElementById('location');
    const dropdown = document.getElementById('locDropdown');
    let debounceTimer = null;
    let activeIdx = -1;
    let items = [];

    function renderItems(results) {
        items = results;
        activeIdx = -1;
        if (!results.length) {
            dropdown.innerHTML = '<div class="autocomplete-loading">No results found</div>';
            dropdown.classList.add('show');
            return;
        }
        dropdown.innerHTML = results.map((r, i) => {
            const parts = r.display_name.split(', ');
            const main = parts.slice(0, 2).join(', ');
            const detail = parts.slice(2).join(', ');
            return `<div class="autocomplete-item" data-index="${i}">
                <div class="loc-main">${main}</div>
                ${detail ? `<div class="loc-detail">${detail}</div>` : ''}
            </div>`;
        }).join('');
        dropdown.classList.add('show');
    }

    function selectItem(idx) {
        if (idx < 0 || idx >= items.length) return;
        locInput.value = items[idx].display_name;
        dropdown.classList.remove('show');
        dropdown.innerHTML = '';
    }

    function fetchSuggestions(query) {
        if (query.length < 2) { dropdown.classList.remove('show'); return; }
        dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
        dropdown.classList.add('show');

        fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query)}&addressdetails=1&featuretype=city`,
            { headers: { 'Accept-Language': 'en' } })
            .then(r => r.json())
            .then(data => renderItems(data))
            .catch(() => { dropdown.innerHTML = '<div class="autocomplete-loading">Search failed</div>'; });
    }

    locInput.addEventListener('input', function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => fetchSuggestions(this.value.trim()), 300);
    });

    locInput.addEventListener('keydown', function (e) {
        if (!dropdown.classList.contains('show') || !items.length) return;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIdx = Math.min(activeIdx + 1, items.length - 1);
            updateActive();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIdx = Math.max(activeIdx - 1, 0);
            updateActive();
        } else if (e.key === 'Enter' && activeIdx >= 0) {
            e.preventDefault();
            selectItem(activeIdx);
        } else if (e.key === 'Escape') {
            dropdown.classList.remove('show');
        }
    });

    function updateActive() {
        dropdown.querySelectorAll('.autocomplete-item').forEach((el, i) => {
            el.classList.toggle('active', i === activeIdx);
        });
    }

    dropdown.addEventListener('mousedown', function (e) {
        const item = e.target.closest('.autocomplete-item');
        if (item) { e.preventDefault(); selectItem(parseInt(item.dataset.index)); }
    });

    document.addEventListener('click', function (e) {
        if (!e.target.closest('.autocomplete-wrap')) dropdown.classList.remove('show');
    });
})();
</script>
</body>
</html>
